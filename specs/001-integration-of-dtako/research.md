# 調査結果: dtako_mod統合

**作成日**: 2025-09-12  
**フェーズ**: 0 - 調査と要件明確化

## 概要
dtako_modサブモジュールの実装に関する技術的な不明点を調査し、意思決定を文書化します。

## 調査項目と決定事項

### 1. 本番データベース認証方法
**決定**: 環境変数による認証情報管理  
**理由**: 
- 標準的なプラクティス
- セキュアな管理が可能（.envファイルはgitignore）
- 環境ごとの設定切り替えが容易

**考慮した代替案**:
- 証明書認証: より安全だが設定が複雑
- OAuth/JWT: APIには適しているがDB接続には過剰
- ハードコード: セキュリティリスクが高い

### 2. データ同期頻度
**決定**: オンデマンド（手動トリガー）  
**理由**:
- 初期実装をシンプルに保つ
- 管理者が必要に応じて実行
- 本番DBへの負荷を制御可能

**考慮した代替案**:
- スケジュール実行: cron/定期実行（将来の拡張として検討）
- リアルタイム同期: 本番への負荷が大きい
- イベント駆動: 複雑性が高い

### 3. 重複データの処理戦略
**決定**: 主キーによるUPSERT（INSERT ... ON DUPLICATE KEY UPDATE）  
**理由**:
- MySQLネイティブ機能で効率的
- 部分的な再インポートが安全
- トランザクション整合性を保証

**考慮した代替案**:
- 削除後インポート: データ損失リスク
- スキップ: 更新されたデータを反映できない
- タイムスタンプ比較: 複雑で誤差の可能性

### 4. インポート日付範囲の上限
**決定**: デフォルト1ヶ月、最大3ヶ月  
**理由**:
- 1ヶ月: 通常の運用に十分
- 3ヶ月: 四半期レポートに対応
- パフォーマンスとのバランス

**考慮した代替案**:
- 無制限: パフォーマンス問題のリスク
- 1週間: 用途が限定的
- 1年: 処理時間が長すぎる

### 5. エラーハンドリング戦略
**決定**: 部分的成功を許可し、詳細なエラーレポート  
**理由**:
- 大量データの一部エラーで全体を止めない
- 問題のあるレコードを特定可能
- 再試行が容易

**考慮した代替案**:
- 全て成功または全て失敗: 大量データには不適切
- エラー無視: 問題の発見が困難
- 自動リトライ: 無限ループのリスク

### 6. パフォーマンス最適化
**決定**: バッチ処理（1000件単位）  
**理由**:
- メモリ使用量を制限
- トランザクションサイズの最適化
- 進捗報告が可能

**考慮した代替案**:
- 1件ずつ: 遅すぎる
- 全件一括: メモリ不足のリスク
- 動的調整: 実装が複雑

## 技術スタックの確定

### データベース接続
- **ドライバー**: github.com/go-sql-driver/mysql v1.7.1
- **接続プール**: デフォルト設定（MaxOpenConns: 25, MaxIdleConns: 25）
- **タイムアウト**: 5分（大量データインポート対応）

### APIフレームワーク
- **ルーター**: github.com/go-chi/chi/v5
- **ミドルウェア**: ロギング、リカバリー、タイムアウト
- **レスポンス形式**: JSON

### 設定管理
- **ライブラリ**: github.com/joho/godotenv
- **設定ファイル**: .env（ローカル）、環境変数（本番）
- **秘密情報**: 環境変数で管理

### ロギング
- **形式**: 構造化ログ（JSON）
- **レベル**: INFO（デフォルト）、DEBUG（開発）
- **出力先**: stdout（コンテナ対応）

## セキュリティ考慮事項

1. **認証情報の保護**
   - .envファイルはgitignore
   - 本番環境では環境変数使用
   - ログに認証情報を出力しない

2. **SQLインジェクション対策**
   - プリペアドステートメント使用
   - パラメータバインディング

3. **レート制限**
   - 同時インポート数を制限（デフォルト: 1）
   - 本番DBへの接続数制限

## 次のステップ

Phase 1（設計とコントラクト）で以下を作成：
1. データモデル定義（data-model.md）
2. APIコントラクト（OpenAPI仕様）
3. コントラクトテスト
4. クイックスタートガイド

## 未解決の課題

なし - すべてのNEEDS CLARIFICATIONは解決済み